{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h2 class="mb-0">Dashboard</h2>
    <p class="text-muted mb-0">Welcome back, {{ user.username }}!</p>
  </div>
</div>

<!-- Stats Cards -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <p class="text-muted small mb-1">Active Plans</p>
            <h4 class="mb-0">{{ total_plans }}</h4>
          </div>
          <div class="text-primary" style="font-size: 2rem; opacity: 0.2;">
            <i class="bi bi-graph-up"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <p class="text-muted small mb-1">Running Campaigns</p>
            <h4 class="mb-0">{{ total_campaigns }}</h4>
          </div>
          <div class="text-success" style="font-size: 2rem; opacity: 0.2;">
            <i class="bi bi-megaphone"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <p class="text-muted small mb-1">Total Leads</p>
            <h4 class="mb-0">{{ total_leads }}</h4>
          </div>
          <div class="text-warning" style="font-size: 2rem; opacity: 0.2;">
            <i class="bi bi-people"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <p class="text-muted small mb-1">Total Budget</p>
            <h4 class="mb-0">${{ total_budget }}</h4>
          </div>
          <div class="text-danger" style="font-size: 2rem; opacity: 0.2;">
            <i class="bi bi-cash-coin"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Prediction Models Section -->
<div class="mb-4">
  <h5 class="mb-3">AI Prediction Models</h5>
  <div class="row g-3">
    <div class="col-md-4">
      <div class="card shadow-sm border-0 h-100 hover-card prediction-card" style="cursor: pointer;" data-model="rebate" data-url="{% url 'launch_rebate' %}">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
              <i class="bi bi-receipt text-success" style="font-size: 1.5rem;"></i>
            </div>
            <h5 class="mb-0">Rebate Prediction</h5>
          </div>
          <p class="text-muted small mb-0">
            Analyze rebate contracts, validate models, and run prediction pipelines.
          </p>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card shadow-sm border-0 h-100 hover-card prediction-card" style="cursor: pointer;" data-model="claim-cost" data-url="{% url 'launch_claim_cost' %}">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
              <i class="bi bi-graph-up-arrow text-primary" style="font-size: 1.5rem;"></i>
            </div>
            <h5 class="mb-0">Claim Cost Prediction</h5>
          </div>
          <p class="text-muted small mb-0">
            Forecast 2025 claim costs with KPIs, product insights, and validation metrics.
          </p>
        </div>
      </div>
    </div>

    

    <div class="col-md-4">
      <div class="card shadow-sm border-0 h-100 hover-card prediction-card" style="cursor: pointer;" data-model="tactic-efficiency" data-url="{% url 'launch_tactic_efficiency' %}">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
              <i class="bi bi-bullseye text-info" style="font-size: 1.5rem;"></i>
            </div>
            <h5 class="mb-0">Tactic Efficiency</h5>
          </div>
          <p class="text-muted small mb-0">
            Explore efficiency forecasts and product-group tactical insights.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block extra_head %}
<style>
.hover-card {
  transition: transform 0.2s, box-shadow 0.2s;
}
.hover-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const predictionCards = document.querySelectorAll('.prediction-card');
  
  predictionCards.forEach(card => {
    card.addEventListener('click', function() {
      const modelName = this.dataset.model;
      const launchUrl = this.dataset.url;
      launchPredictionModel(this, modelName, launchUrl);
    });
  });
});

function launchPredictionModel(cardElement, modelName, launchUrl) {
  // Show loading indicator
  const btnText = cardElement.querySelector('h5');
  const originalText = btnText.textContent;
  btnText.textContent = 'Launching...';
  
  fetch(launchUrl, {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Show success message
      alert(data.message + '\n\nOpening dashboard in new tab...');
      // Open dashboard in new tab
      window.open(data.url, '_blank');
    } else {
      alert('Error: ' + (data.error || 'Failed to launch dashboard'));
    }
    btnText.textContent = originalText;
  })
  .catch(error => {
    alert('Error launching dashboard: ' + error);
    btnText.textContent = originalText;
  });
}
</script>
{% endblock %}
